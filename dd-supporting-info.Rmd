---
title: "Supporting information to: `r rmarkdown::yaml_front_matter('dd-paper.Rmd')$title`"
# subtitle: Do you have a subtitle? If so, write it here
# titlerunning: Short form of title (if too long for head)
# authorrunning: Short form of author list if too long for running head
authors:
  - name: Henning Teickner
    affil: '1,2,*'
    email:
  - name: Julien Arsenault
    affil: '3'
    email:
  - name: Mariusz Gałka
    affil: '4'
    email:    
  - name: Klaus-Holger Knorr
    affil: '1'
    email:
#  - name: Alice Author
#    affil: "1,**"
#    email: alice@doe.com
#  - name: Bob Author
#    affil: "1,**"
#    email: bob@doe.com
#  - name: Christine Author
#    affil: "1,2"
#    email: christine@doe.com
#  - name: Derek Author
#    affil: "2,*"
#    email: derek@doe.com
#
affiliations:
  - number: 1
    text: "Ecohydrology & Biogeochemistry Group, Institute of Landscape Ecology, University of Münster, 48149, Germany"
  - number: 2
    text: "Spatiotemporal Modelling Lab, Institute for Geoinformatics, University of Münster, 48149, Germany"
  - number: 3
    text: "Département des Sciences biologiques, Université du Québec à Montréal, Montréal, H2X 1Y4, Canada"
  - number: 4
    text: "University of Lodz, Faculty of Biology and Environmental Protection, Department of Biogeography, Paleoecology and Nature Conservation, Banacha 1/3, 90-237 Łodz, Poland"
#  - number: "**"
#    text: "these authors contributed equally to this work"
  - number: "*"
    text: "corresponding author(s): Henning Teickner (henning.teickner@uni-muenster.de)"
#
keywords:
- key
- dictionary
- word

#PACS: 
#- PAC1
#- superPAC

bibliography: '`r targets::tar_read(dd_references_file)`'
biblio-style: copernicus
# bibstyle options spbasic(default), spphys, spmpsci
# csl: copernicus-publications.csl
output: 
  bookdown::pdf_document2:
    toc: true
    keep_tex: true
    number_sections: true
    citation_package: natbib
fontsize: 12pt
link-citations: true
header-includes:
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{multirow}
  - \usepackage[modulo]{lineno}
  - \linenumbers
  - \usepackage{xr} \externaldocument[main-]{dd-paper}
---

\renewcommand{\thefigure}{S\arabic{figure}} 
\renewcommand{\thetable}{S\arabic{table}}
\renewcommand{\thesection}{S\arabic{section}}
\renewcommand{\theequation}{S\arabic{equation}}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, fig.align='center', fig.pos = 'H')
```

```{r packages, include=FALSE}
library(knitr)
library(kableExtra)
library(pmird)
library(targets)
library(magrittr)
library(bib2df)
library(RMariaDB)
```


```{r}
targets::tar_source()
tar_load(dd_simulation_1)
targets::tar_load(dd_model_info)
targets::tar_load(dd_data_model)
targets::tar_load(dd_data_pmird_peat_cores_yhat)
dd_data_pmird_peat_cores_yhat <- purrr::map(dd_data_pmird_peat_cores_yhat, readRDS_rvars)
tar_load(dd_citations_data)
tar_load(dd_stan_1_mcmc_settings)
dd_reconstruction_initial_mass_rate_1 <- readRDS_rvars(tar_read(dd_reconstruction_initial_mass_rate_1))
targets::tar_load(dd_simulation_4)
```



```{r, results='asis'}
cat(dd_make_author_list(rmarkdown::metadata$authors))
cat("  \n")
cat("  \n")
cat(dd_make_affiliation_list(rmarkdown::metadata$affiliations))
```


# Age-depth-models for peat cores {#dd-sup-age-depth-model}

```{r, results='asis'}
tar_load(dd_plot_21)
tar_load(dd_rbacon_csv)
target_core_label <- stringr::str_extract(names(dd_rbacon_csv), pattern = "(MH1|MK1|OD2)")

for(i in seq_along(dd_plot_21)) {
  cat(paste0('(ref:dd-plot-21-', i, '-caption) rbacon Age-depth model for core ', target_core_label[[i]], '.\n\n'))
}
```


```{r dd-plot-21, fig.cap=paste0('(ref:dd-plot-21-', seq_along(dd_plot_21), '-caption)'), out.width='100%'}
knitr::include_graphics(dd_plot_21)
```


# Peat samples within and outside prediction domains of the models

(ref:dd-plot-17-caption) Preprocessed spectra (clipped, baseline corrected, normalized, binned) of the peat samples analyzed in this study, assigned to panels depending on whether they are or are not within the prediction domain (columns) of the different models (rows). 

```{r dd-plot-17, fig.cap='(ref:dd-plot-17-caption)', out.width='100%'}
knitr::include_graphics(tar_read(dd_plot_17))
```

(ref:dd-plot-18-caption) Kernel density estimate plots for carbon contents and HI$_{1630/1090}$ for peat samples analyzed in this study, grouped by whether the samples are or are not within the prediction domain of the different models (rows). 

```{r dd-plot-18, fig.cap='(ref:dd-plot-18-caption)', out.width='100%'}
knitr::include_graphics(tar_read(dd_plot_18))
```


# Sensitivity of $\gamma_\text{MIRS}$ to admixtures of minerals and strongly decomposed peat

(ref:dd-plot-16-caption) Preprocessed spectrum (clipped, baseline corrected, normalized) for the mineral-rich peat sample from the pmird database [@Drollinger.2019; @Drollinger.2020]

```{r dd-plot-16, fig.cap='(ref:dd-plot-16-caption)', out.width='100%'}
knitr::include_graphics(tar_read(dd_plot_16))
```

```{r, results='asis'}
for(i in seq_along(tar_read(dd_plot_1))) {
  cat(paste0("(ref:dd-plot-1-", i, "-caption) Predictions of the degree of decomposition ($\\gamma_\\text{MIRS}$) for selected litter samples from the trainig data with varying additions of a peat sample with large mineral contents for model ", dd_model_names(i, dd_model_info), ". The black line represents median predictions, shaded areas are prediction inverals with significance level indicated in the legend. Points are the degree of decomposition measured in litterbag experiments or assumed as 0% for undecomposed litter.\n\n"))
}
```

```{r dd-plot-1, fig.cap=paste0('(ref:dd-plot-1-', seq_along(tar_read(dd_plot_1)), '-caption)'), out.width='100%'}
knitr::include_graphics(tar_read(dd_plot_1))
```


```{r, results='asis'}
for(i in seq_along(tar_read(dd_plot_5))) {
  cat(paste0("(ref:dd-plot-5-", i, "-caption) Predictions of the degree of decomposition ($\\gamma_\\text{MIRS}$) for selected litter samples from the trainig data with varying additions of a peat sample with large degree of decomposition for model ", dd_model_names(i, dd_model_info), ". The black line represents median predictions, shaded areas are prediction inverals with significance level indicated in the legend. Points are the degree of decomposition measured in litterbag experiments or assumed as 0% for undecomposed litter.\n\n"))
}
```

```{r dd-plot-5, fig.cap=paste0('(ref:dd-plot-5-', seq_along(tar_read(dd_plot_5)), '-caption)'), out.width='100%'}
knitr::include_graphics(tar_read(dd_plot_5))
```

<!--
# Relation of other decomposition indicators to the predicted degree of decomposition for the analyzed peat cores

```{r, results='asis'}
for(i in seq_along(tar_read(dd_plot_6_1))[-2]) {
  cat(paste0("(ref:dd-plot-6-1-", i, "-caption) Relation of decomposition indicators to the  degree of decomposition of peat samples predicted by model ", dd_model_names(i, dd_model_info), ". Columns are cores and rows are decomposition indicators. $\\rho$ is the Pearson correlation computed with average values (not considering measurement or prediction errors) across all cores. \"Reliability\" refers to how reliable the decomposition indicator values are. MIRS predicted variables are less reliable when they are not in the prediction domain, making some of our analyses more speculative than others. All values for O/C, H/C, $\\Delta$G$_\\text{f}^0$, and NOSC are predicted from MIRS. For all other decomposition indicators, variable numbers of values were predicted from MIRS. Error bars are standard deviations.\n\n"))
}
```

```{r dd-plot-6-1, fig.cap=paste0('(ref:dd-plot-6-1-', seq_along(tar_read(dd_plot_6_1))[-2], '-caption)'), out.width='80%'}
knitr::include_graphics(tar_read(dd_plot_6_1)[-2])
```
-->


# Estimating relative differences of optimal decomposition rates between litter types and the decrease of decomposition rates as mass is lost from $\gamma_\text{MIRS}$ {#dd-rate-differences-1}

Here, we show that $\gamma_\text{MIRS}$ may be useful to estimate relative differences of optimal decomposition rates between litter types, or alternatively the slow-down of decomposition the more of the initial mass is lost, as assumed in the decomposition module of the Holocene Peatland Model (HPM) [@Frolking.2001; @Frolking.2010]. To this end, we first show that when assuming exponential decay or the decomposition module of the HPM, decomposition under the same environmental conditions simply scales the litter type-specific optimal decomposition rate by the combined effect of environmental conditions over time (we call this combined effect the decomposition progress). This allows to cancel the influence of environmental conditions from the decomposition formulas when taking the difference or ratio of the decomposition formulas for litter types decomposing under the same environmental conditions, which allows to estimate the ratio of optimal decomposition rates for the litter types or the decrease of decomposition rates as decomposition progresses, given that $\gamma$ of each litter type and the respective other term (the litter-specific decomposition rates or the decrease of decomposition rates as decomposition progresses are known).  
We define the decomposition progress as the sum of environmental controls on decomposition rates over the time steps (assuming that environmental conditions are constant within a time step). Thus, when environmental conditions are favorable for decomposition, one time step will increase the decomposition progress more than when environmental conditions limit decomposition.  
Calculation of $\gamma$ and mass loss are straightforward in the two decomposition models described in @Frolking.2001 (exponential decay and decomposition with rates slowing down as decomposition progresses; these models are also part of the Holocene Peatland Model [@Frolking.2010] and other peatland models [e.g., @Morris.2012]). Therefore, if we compute remaining masses of two litter types that decomposed under the same environmental conditions (for example because they are part of the same peat layer), we can separate the litter type-specific decomposition rate from the scaling by environmental conditions over time (the decomposition progress). This allows efficient computation of remaining masses under step-wise constant environmental conditions over time and it allows comparisons of $\gamma$ between litter types under the same decomposition progress.  
The first decomposition model is the solution of equation (3) in @Frolking.2001 with $\alpha = 1$, which is exponential decay as used in many models [e.g., @Clymo.1984]:

\begin{equation}
m_{ij}(t) = m_{ij}(t_0) \exp(-k_{ij} t).
(\#eq:eq-dd-rate-differences-1)
\end{equation}

Here, the mass of litter type $i$ in layer $j$ at time $t$ is $m_{ij}(t)$, the initial mass of the layer is $m_{ij}(t_0)$ and $k_{ij}$ is the decomposition rate of litter type $i$ in layer $j$, which is constant over the considered time period. In the HPM and other models, $k_{ij}$ is assumed to be the product of some optimal litter type-specific decomposition rate $k_{0,i}$ and time-dependent functions that describe how environmental conditions scale $k_{0,i}$. For example, $f_j(t)$ may describe how peat water content in layer $j$ at time $t$ modifies the decomposition rate. Note that the environmental controls are assumed to scale the decomposition rates of all litter types in the same way, that is, $f_j(t)$ does not depend on the litter type. @Frolking.2001 also suggests to assume that $f_j(t)$ is constant for one time step, i.e. $f_j(t) = a$ for $t_0 \le t < t_0 + \Delta t$ for some value $a>0$ and some time values $t_0, t_0 + \Delta t$ that define the temporal grid. Then, we have at time $t_0 + n\Delta t$, with $\Delta t=1$:

\begin{equation}
m_{ij}(t_0 + n) = m_{ij}(t_0) \prod_{z = 1}^{n} \exp(-k_{0,i} f_j(t_0 + z))) = m_{ij}(t_0) \exp(-k_{0,i}) \exp(\sum_{z = 1}^{n} f_j(t_0 + z)),
(\#eq:eq-dd-rate-differences-2)
\end{equation}

The second decomposition model is the solution of equation (3) in @Frolking.2001 with $\alpha > 1$, which means that decomposition rates decrease as mass gets lost, where $\alpha$ is a scaling factor and larger values lead to a faster decrease of decomposition rates:

\begin{equation}
m_{ij}(t) = \frac{m_{ij}(t_0)}{(1 + (\alpha - 1) k_{ij}t)^{\frac{1}{\alpha - 1}}},
(\#eq:eq-dd-rate-differences-3)
\end{equation}

where $\alpha>1$ controls how much decomposition rates decrease as mass is lost. Equation \@ref(eq:eq-dd-rate-differences-3) can be derived from the following differential equation:

\begin{equation}
\frac{dm_{ij}(t)}{dt} = -k_{0,i} m_{ij}(t_0)\left(\frac{m_{ij}(t)}{m_{ij}(0)}\right)^{\alpha},
(\#eq:eq-dd-rate-differences-4)
\end{equation}

which becomes

\begin{equation}
\frac{dm_{ij}(t)}{dt} = -k_{0,i} f_j(t) m_{ij}(t_0)\left(\frac{m_{ij}(t)}{m_{ij}(0)}\right)^{\alpha},
(\#eq:eq-dd-rate-differences-5)
\end{equation}

when we include environmental controls of the decomposition rate, $f_j(t)$. Assuming again that $f_j(t)$ is constant for intervals on the defined time grid, we can solve the differential equation for the time period $[t_0, t_0 + n\Delta t]$ ($\Delta t$ is the resolution of the time grid, which here is set to 1, $n$ is a natural number) as follows:

\begin{equation}
\begin{aligned}
&& \frac{dm_{ij}(t)}{dt} &=& -k_{0,i} f_j(t) m_{ij}(t_0) \left(\frac{m_{ij}(t)}{m_{ij}(t_0)}\right)^{\alpha}\\
&\iff& \frac{1}{m_{ij}(t)^\alpha}dm_{ij}(t) &=& -k_{0,i} f_j(t) m_{ij}(t_0) \left(\frac{1}{m_{ij}(t_0)}\right)^{\alpha} dt\\
&\iff& \int_{m_{ij}(t_0)}^{m_{ij}(t_0 + n\Delta t)} \frac{1}{m_{ij}(t)^\alpha}dm_{ij}(t) &=& \int_{t_0}^{t_0 + n\Delta t} -k_{0,i} f_j(t) m_{ij}(0) \left(\frac{1}{m_{ij}(0)}\right)^{\alpha} dt\\
&\iff& \frac{m_{ij}(t_0 + n)^{-\alpha + 1} - m_{ij}(t_0)^{-\alpha + 1}}{1 - \alpha} &=& -k_{0,i} \sum_{z = 1}^{n} f_j(t_0 + z)  \int_{t_0}^{t_0 + n\Delta t} m_{ij}(t_0) \left(\frac{1}{m_{ij}(t_0)}\right)^{\alpha} dt\\
&\iff& \frac{m_{ij}(t_0 + n)^{-\alpha + 1} - m_{ij}(t_0)^{-\alpha + 1}}{1 - \alpha} &=& -k_{0,i} \left(\frac{1}{m_{ij}(t_0)}\right)^{\alpha-1} \sum_{z = 1}^{n} f_j(t_0 + z)\\
&\iff& m_{ij}(t_0 + n)^{-\alpha + 1} &=& m_{ij}(t_0)^{-\alpha + 1} \left(1 + (\alpha - 1) k_{0,i} \sum_{z = 1}^{n} f_j(t_0 + z) \right)\\
&\iff& m_{ij}(t_0 + n) &=& \frac{m_{ij}(t_0)}{\left( 1 + (\alpha - 1) k_{0,i} \sum_{z = 1}^{n} f_j(t_0 + z) \right)^\frac{1}{\alpha - 1}}\\
\end{aligned}
(\#eq:eq-dd-rate-differences-6)
\end{equation}

Thus, we can use the decomposition progress as defined at the start of this subsection ($\sum_{z = 1}^{n} f_j(t_0 + z)$) with both decomposition formulas to analyze how $\gamma$ of two litter types decomposing under the same environmental conditions (= having the same decomposition progress) differs.  
If the two decomposition models are accurate and we have measured $\gamma$ of two litter types from the same peat layer, we can compute the difference or ratio of their litter type-specific decomposition rates ($k_{0,i}$) under optimal conditions. Alternatively, when we know the litter type-specific decomposition rates under optimal conditions for two litter types in the same peat layer, we can estimate $\alpha$. This is useful because $\alpha$ can neither be estimated accurately from litterbag data nor from fitting decomposition models to dated peat cores [@Frolking.2001; @Teickner.2025]. Of course, this approach assumes that decomposition happens according to equation \@ref(eq:eq-dd-rate-differences-6). Therefore, it is also useful to compare $\alpha$ estimated across different layers.  
To show that these computations are possible, assume that there are two litter types in layer $j$, say $i=1$ is *S. fuscum* material and $i=2$ is *Calluna vulgaris* leaf material. For the first model, the decomposition rate for litter type $i$ can be derived from equation \@ref(eq:eq-dd-rate-differences-2):

\begin{equation}
k_{0,i} = -\log\left( \frac{m_{ij}(t + n)}{m_{ij}(t_0) \exp(\sum_{z = 1}^{n} f_j(t_0 + z))} \right) = -\log\left( \frac{1 - \gamma_{ij}(t + n)}{\exp(\sum_{z = 1}^{n} f_j(t_0 + z))} \right),
(\#eq:eq-dd-rate-differences-7)
\end{equation}

where $\gamma$ is the degree of decomposition. The difference between the decomposition rates of both litter types under optimal environmental conditions is:

\begin{equation}
\begin{aligned}
k_{0,1} - k_{0,2} &=& \log\left( \frac{1 - \gamma_{2j}(t)}{\exp(\sum_{z = 1}^{n} f_j(t_0 + z))} \right) - \log\left( \frac{1 - \gamma_{1j}(t)}{\exp(\sum_{z = 1}^{n} f_j(t_0 + z))} \right)\\
&=&  \log\left( \frac{(1 - \gamma_{2j}(t)) \exp(\sum_{z = 1}^{n} f_j(t_0 + z))}{(1 - \gamma_{1j}(t)) \exp(\sum_{z = 1}^{n} f_j(t_0 + z))} \right)\\
&=& \log(1 - \gamma_{2j}(t)) - \log(1 - \gamma_{1j}(t))\\
\end{aligned}
(\#eq:eq-dd-rate-differences-8)
\end{equation}

For the second model, the decomposition rate for litter type $i$ can be derived from equation \@ref(eq:eq-dd-rate-differences-6):

\begin{equation}
\begin{aligned}
k_{0,i} &=& \frac{m_{ij}(t_0)^{-\alpha + 1} - m_{ij}(t_0 + n)^{-\alpha + 1}}{(1 - \alpha) m_{ij}(t_0)^{-\alpha + 1} \sum_{z = 1}^{n} f_j(t_0 + z)}\\
k_{0,i} &=& \frac{1 - (1 - \gamma_{ij}(t))^{-\alpha + 1}}{(1 - \alpha) \sum_{z = 1}^{n} f_j(t_0 + z)}\\
\end{aligned}
(\#eq:eq-dd-rate-differences-9)
\end{equation}

The ratio of the decomposition rates of both litter types under optimal environmental conditions is:

\begin{equation}
\begin{aligned}
\frac{k_{0,1}}{k_{0,2}} &=& \frac{(1 - \alpha) \sum_{z = 1}^{n} f_j(t_0 + z) (1 - (1 - \gamma_{1j}(t))^{-\alpha + 1})}{(1 - \alpha) \sum_{z = 1}^{n} f_j(t_0 + z) (1 - (1 - \gamma_{2j}(t))^{-\alpha + 1})}\\
\frac{k_{0,1}}{k_{0,2}} &=& \frac{(1 - (1 - \gamma_{1j}(t))^{-\alpha + 1})}{(1 - (1 - \gamma_{2j}(t))^{-\alpha + 1})}
\end{aligned}
(\#eq:eq-dd-rate-differences-10)
\end{equation}


# References {-}


